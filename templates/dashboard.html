<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>QR Attendance Dashboard</title>
<style>
  body { font-family: Arial,sans-serif; background: linear-gradient(135deg,#667eea,#764ba2); margin:0; color:#333; text-align:center; padding:20px; }
  .container { background:#fff; max-width:480px; margin:auto; border-radius:15px; padding:30px; box-shadow:0 0 20px rgba(0,0,0,0.2); }
  h1 { background:linear-gradient(135deg,#667eea,#764ba2); -webkit-background-clip:text; -webkit-text-fill-color:transparent; margin-bottom:1rem; }
  img { width:250px; height:250px; border-radius:15px; margin:20px 0; }
  .timer { background:#667eea; color:#fff; font-size:1.3rem; padding:10px 25px; border-radius:50px; font-weight:bold; margin-bottom:15px; display:inline-block;}
  .url { font-family: monospace; background:#f0f4f8; padding:12px; border-radius:8px; word-break:break-word; }
</style>
</head>
<body>
  <div class="container">
    <h1>QR Attendance</h1>
  <img id="qr-img" src="{{ url_for('static', filename=qr_filename) }}?t={{ time_remaining }}" alt="QR Code" />
    <div class="timer" id="timer">{{ time_remaining }} seconds remaining</div>
    <div class="url" id="qr-url">{{ qr_url }}</div>
  </div>
<script>
  let remaining = {{ time_remaining }};
  const timerEl = document.getElementById('timer');
  const qrImage = document.getElementById('qr-img');
  const qrUrlDisplay = document.getElementById('qr-url');
  
  function reloadQR() {
    fetch('/start_session')
      .then(resp => resp.json())
      .then(data => {
        // Reload QR image (force refresh) - use full static URL returned by server if present
        if (data.qr_static) {
          qrImage.src = data.qr_static + '?t=' + new Date().getTime();
        } else if (data.qr_filename) {
          qrImage.src = '/' + data.qr_filename + '?t=' + new Date().getTime();
        }
        // Update any URL displayed
        qrUrlDisplay.textContent = data.qr_url || '';
        // Reset timer
        remaining = data.time_remaining || remaining;
        updateTimerText();
      }).catch(err => console.error('Failed to reload QR', err));
  }

  function updateTimerText() {
    timerEl.textContent = remaining + " seconds remaining";
  }
  
  // Countdown and refresh logic
  setInterval(() => {
    if (remaining > 0) {
      remaining--;
      updateTimerText();
    }
    if (remaining === 0) {
      reloadQR();
    }
  }, 1000);
</script>
</body>
</html>
